#!/usr/bin/python
# -*- coding: utf-8 -*-
#
# Licensed under the GNU General Public License, version 3.
# See the file http://www.gnu.org/licenses/gpl.txt

from pisi.actionsapi import shelltools
from pisi.actionsapi import pisitools
from pisi.actionsapi import get

# suppress strip warnings
NoStrip = "/"

def setup():
    # Delete bundle version from Gemfile.lock
    # https://github.com/bundler/bundler/issues/6882
    shelltools.system("sed -e '/BUNDLED WITH/,+1d' -i Gemfile.lock")
    shelltools.system("bundle config build.nokogiri --use-system-libraries")
    shelltools.system("sed 's|git ls-files|find -type f|' -i metasploit-framework.gemspec")

def build():
    shelltools.export("CFLAGS", " -I/usr/include/libxml2 %s" % get.CFLAGS())
    shelltools.system("bundle config set deployment 'true'")
    shelltools.system("bundle config set no-cache 'true'")
    shelltools.system("bundle install -j2")
    shelltools.system("find vendor/bundle/ruby -exec chmod o+r '{}' \;")
    shelltools.system("find vendor/bundle/ruby \( -name gem_make.out -or -name mkmf.log \) -delete")


def install():
    shelltools.makedirs(get.installDIR() + "/usr/bin")
    
    for i in ["msf-json-rpc.ru", "msf-ws.ru", "msfconsole", "msfd", "msfdb", "msfrpc", "msfrpcd", "msfupdate", "msfvenom", "msfvenom"]:
        msfBashFile = open(get.installDIR() + "/usr/bin/%s" % i, "w")
        msfBashFile.write("#!/bin/sh\nBUNDLE_GEMFILE=/opt/metasploit/Gemfile bundle exec ruby /opt/metasploit/%s \"$@\"\n" % i)
        msfBashFile.close()
        shelltools.system("chmod +x '%s/usr/bin/%s'" % (get.installDIR(), i))
    
    shelltools.copytree(get.workDIR() + "/metasploit-framework-%s/" % get.srcVERSION(), "%s/opt/metasploit/" % get.installDIR())
    '''
    shelltools.cd("%s/opt/metasploit/" % get.installDIR())
    shelltools.system("bundle install --jobs=2 --no-cache --deployment")
    shelltools.system("find vendor/bundle/ruby/*/gems/robots-* -exec chmod o+r '{}' \;")
    '''
    # install completation files
    pisitools.insinto("/usr/share/zsh/site-functions", "external/zsh/_*")
    # install documentation
    shelltools.cd("%s/metasploit-framework-%s" % (get.workDIR(), get.srcVERSION()))
    pisitools.insinto("/%s/metasploit" % get.docDIR(), "documentation/*")
    pisitools.dodoc("COPYING", "LICENSE", "README*")